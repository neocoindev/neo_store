{% extends 'partials/base.html' %} 
{% load static %} 
{% load humanize %} 
{% load currency_tags %}

{% block content %}

<!-- Подключение стилей для улучшенного каталога -->
<link href="{% static 'assets/css/shop.css' %}" rel="stylesheet" />
<link href="{% static 'assets/css/filters.css' %}" rel="stylesheet" />

<section class="middle">
    <div class="container">
        <!-- Заголовок с количеством товаров -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold mb-0">Все товары (<span class="product_count">{{ products_list.count }}</span>)</h2>
        </div>
        
        <!-- Секция поиска и фильтров -->
        <div class="wb-filters-section mb-4">
            <div class="mb-3 d-flex justify-content-between align-items-center gap-2">
                <input 
                    type="text" 
                    class="form-control rounded search-filter" 
                    placeholder="Поиск товаров..." 
                    name="search-filter" 
                    value="{{ request.GET.q }}"
                />
                <button class="btn bg-primary text-white rounded">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Боковая панель фильтров (Desktop) -->
            <div class="col-lg-3 wb-filters-sidebar">
                <!-- Категории -->
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Категории</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        {% for c in categories %}
                            <label class="wb-filter-item">
                                <input type="checkbox" class="wb-filter-checkbox category-filter" 
                                       data-filter="categories" data-value="{{c.id}}" 
                                       value="{{c.id}}" id="category{{c.id}}">
                                <span class="wb-filter-label">{{c.title}}</span>
                                <span class="wb-filter-count">({{c.product_count|default:0}})</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Цена -->
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Цена</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        <div class="wb-price-filter">
                            <div class="wb-price-inputs">
                                <input type="number" id="wb-price-range-min-desktop" class="wb-filter-range" 
                                       placeholder="От" min="{{price_range.min_price|default:0}}" 
                                       max="{{price_range.max_price|default:10000}}">
                                <span>-</span>
                                <input type="number" id="wb-price-range-max-desktop" class="wb-filter-range" 
                                       placeholder="До" min="{{price_range.min_price|default:0}}" 
                                       max="{{price_range.max_price|default:10000}}">
                            </div>
                        </div>
                        {% for p in prices %}
                            <label class="wb-filter-item">
                                <input type="radio" name="price-filter" class="wb-filter-radio" 
                                       value="{{p.id}}" id="price{{p.id}}">
                                <span class="wb-filter-label">{{p.value}}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Рейтинг -->
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Рейтинг</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        {% for r in ratings %}
                            <label class="wb-filter-item">
                                <input type="checkbox" class="wb-filter-checkbox rating-filter" 
                                       data-filter="rating" data-value="{{r.id}}" 
                                       value="{{r.id}}" id="rating{{r.id}}">
                                <span class="wb-filter-label">{{r.value}}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Размеры -->
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Размер</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        <div class="wb-size-grid">
                            {% for s in sizes %}
                                <label class="wb-size-item">
                                    <input type="checkbox" class="wb-filter-checkbox size-filter" 
                                           data-filter="sizes" data-value="{{s.content}}" 
                                           value="{{s.content}}" id="size{{s.content}}">
                                    <span class="wb-size-label">{{s.title}}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Цвета -->
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Цвет</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        <div class="wb-color-grid">
                            {% for c in colors %}
                                <label class="wb-color-item" style="background-color: {{c.code|default:c.content}};">
                                    <input type="checkbox" class="wb-filter-checkbox colors-filter" 
                                           data-filter="colors" data-value="{{c.content}}" 
                                           value="{{c.content}}" id="color{{c.content}}">
                                    <span class="wb-color-name">{{c.title}}</span>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Бренды -->
                {% if brands %}
                <div class="wb-filter-accordion active">
                    <div class="wb-filter-accordion-header">
                        <h4>Бренд</h4>
                        <span class="wb-filter-accordion-toggle"><i class="fas fa-chevron-down"></i></span>
                    </div>
                    <div class="wb-filter-accordion-content">
                        {% for brand in brands %}
                            <label class="wb-filter-item">
                                <input type="checkbox" class="wb-filter-checkbox brand-filter" 
                                       data-filter="brands" data-value="{{brand.brand}}" 
                                       value="{{brand.brand}}" id="brand{{brand.brand}}">
                                <span class="wb-filter-label">{{brand.brand}}</span>
                                <span class="wb-filter-count">({{brand.count}})</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <button class="btn bg-primary btn-sm rounded reset_shop_filter_btn w-100 mt-3">
                    Сбросить фильтр <i class="fas fa-rotate ms-2"></i>
                </button>
            </div>
            
            <!-- Основная область с товарами -->
            <div class="col-lg-9">
                <!-- Активные фильтры (чипсы) -->
                <div id="wb-active-filters" class="wb-active-filters" style="display: none;"></div>
                
                <!-- Сетка товаров (контейнер для AJAX обновлений) -->
                <div class="wb-products-grid" id="products-list">
                    {% include 'partials/_store.html' with products=products %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Подключение JavaScript для улучшенной фильтрации -->
<script src="{% static 'assets/js/shop.js' %}"></script>
<script src="{% static 'assets/js/filters.js' %}"></script>
<script src="{% static 'assets/js/image-preloader.js' %}"></script>

<script>
// Инициализация аккордеонов для десктопной версии
$(document).ready(function() {
    $('.wb-filter-accordion-header').on('click', function() {
        $(this).parent().toggleClass('active');
    });
});
</script>

{% endblock content %}
